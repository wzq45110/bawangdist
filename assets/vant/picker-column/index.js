"use strict";

Object.defineProperty(exports, "__esModule", { value: true });
var component_1 = require('./../common/component.js');
var utils_1 = require('./../common/utils.js');
var DEFAULT_DURATION = 200;
component_1.VantComponent({
    classes: ['active-class'],
    props: {
        valueKey: String,
        className: String,
        itemHeight: Number,
        visibleItemCount: Number,
        initialOptions: {
            type: Array,
            value: []
        },
        defaultIndex: {
            type: Number,
            value: 0
        }
    },
    data: {
        startY: 0,
        offset: 0,
        duration: 0,
        startOffset: 0,
        options: [],
        currentIndex: 0
    },
    created: function created() {
        var _this = this;
        var _a = this.data,
            defaultIndex = _a.defaultIndex,
            initialOptions = _a.initialOptions;
        this.set({
            currentIndex: defaultIndex,
            options: initialOptions
        }).then(function () {
            _this.setIndex(defaultIndex);
        });
    },
    watch: {
        defaultIndex: function defaultIndex(value) {
            this.setIndex(value);
        }
    },
    methods: {
        getCount: function getCount() {
            return this.data.options.length;
        },
        onTouchStart: function onTouchStart(event) {
            this.setData({
                startY: event.touches[0].clientY,
                startOffset: this.data.offset,
                duration: 0
            });
        },
        onTouchMove: function onTouchMove(event) {
            var data = this.data;
            var deltaY = event.touches[0].clientY - data.startY;
            this.setData({
                offset: utils_1.range(data.startOffset + deltaY, -(this.getCount() * data.itemHeight), data.itemHeight)
            });
        },
        onTouchEnd: function onTouchEnd() {
            var data = this.data;
            if (data.offset !== data.startOffset) {
                this.setData({ duration: DEFAULT_DURATION });
                var index = utils_1.range(Math.round(-data.offset / data.itemHeight), 0, this.getCount() - 1);
                this.setIndex(index, true);
            }
        },
        onClickItem: function onClickItem(event) {
            var index = event.currentTarget.dataset.index;
            this.setIndex(index, true);
        },
        adjustIndex: function adjustIndex(index) {
            var data = this.data;
            var count = this.getCount();
            index = utils_1.range(index, 0, count);
            for (var i = index; i < count; i++) {
                if (!this.isDisabled(data.options[i])) return i;
            }
            for (var i = index - 1; i >= 0; i--) {
                if (!this.isDisabled(data.options[i])) return i;
            }
        },
        isDisabled: function isDisabled(option) {
            return utils_1.isObj(option) && option.disabled;
        },
        getOptionText: function getOptionText(option) {
            var data = this.data;
            return utils_1.isObj(option) && data.valueKey in option ? option[data.valueKey] : option;
        },
        setIndex: function setIndex(index, userAction) {
            var _this = this;
            var data = this.data;
            index = this.adjustIndex(index) || 0;
            var offset = -index * data.itemHeight;
            if (index !== data.currentIndex) {
                return this.set({ offset: offset, currentIndex: index }).then(function () {
                    userAction && _this.$emit('change', index);
                });
            }
            return this.set({ offset: offset });
        },
        setValue: function setValue(value) {
            var options = this.data.options;
            for (var i = 0; i < options.length; i++) {
                if (this.getOptionText(options[i]) === value) {
                    return this.setIndex(i);
                }
            }
            return Promise.resolve();
        },
        getValue: function getValue() {
            var data = this.data;
            return data.options[data.currentIndex];
        }
    }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsInZhbHVlIiwiY29tcG9uZW50XzEiLCJyZXF1aXJlIiwidXRpbHNfMSIsIkRFRkFVTFRfRFVSQVRJT04iLCJWYW50Q29tcG9uZW50IiwiY2xhc3NlcyIsInByb3BzIiwidmFsdWVLZXkiLCJTdHJpbmciLCJjbGFzc05hbWUiLCJpdGVtSGVpZ2h0IiwiTnVtYmVyIiwidmlzaWJsZUl0ZW1Db3VudCIsImluaXRpYWxPcHRpb25zIiwidHlwZSIsIkFycmF5IiwiZGVmYXVsdEluZGV4IiwiZGF0YSIsInN0YXJ0WSIsIm9mZnNldCIsImR1cmF0aW9uIiwic3RhcnRPZmZzZXQiLCJvcHRpb25zIiwiY3VycmVudEluZGV4IiwiY3JlYXRlZCIsIl90aGlzIiwiX2EiLCJzZXQiLCJ0aGVuIiwic2V0SW5kZXgiLCJ3YXRjaCIsIm1ldGhvZHMiLCJnZXRDb3VudCIsImxlbmd0aCIsIm9uVG91Y2hTdGFydCIsImV2ZW50Iiwic2V0RGF0YSIsInRvdWNoZXMiLCJjbGllbnRZIiwib25Ub3VjaE1vdmUiLCJkZWx0YVkiLCJyYW5nZSIsIm9uVG91Y2hFbmQiLCJpbmRleCIsIk1hdGgiLCJyb3VuZCIsIm9uQ2xpY2tJdGVtIiwiY3VycmVudFRhcmdldCIsImRhdGFzZXQiLCJhZGp1c3RJbmRleCIsImNvdW50IiwiaSIsImlzRGlzYWJsZWQiLCJvcHRpb24iLCJpc09iaiIsImRpc2FibGVkIiwiZ2V0T3B0aW9uVGV4dCIsInVzZXJBY3Rpb24iLCIkZW1pdCIsInNldFZhbHVlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJnZXRWYWx1ZSJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBQ0FBLE9BQU9DLGNBQVAsQ0FBc0JDLE9BQXRCLEVBQStCLFlBQS9CLEVBQTZDLEVBQUVDLE9BQU8sSUFBVCxFQUE3QztBQUNBLElBQUlDLGNBQWNDLFFBQVEscUJBQVIsQ0FBbEI7QUFDQSxJQUFJQyxVQUFV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QUtNLFdBQUwsQ0FBaUJOLEtBQWpCLEtBQTJCLENBQW5DO0FBQ0EsZ0JBQUl4QixTQUFTLENBQUN3QixLQUFELEdBQVMxQixLQUFLUCxVQUEzQjtBQUNBLGdCQUFJaUMsVUFBVTFCLEtBQUtNLFlBQW5CLEVBQWlDO0FBQzdCLHVCQUFPLEtBQUtJLEdBQUwsQ0FBUyxFQUFFUixRQUFRQSxNQUFWLEVBQWtCSSxjQUFjb0IsS0FBaEMsRUFBVCxFQUFrRGYsSUFBbEQsQ0FBdUQsWUFBWTtBQUN0RTZCLGtDQUFjaEMsTUFBTWlDLEtBQU4sQ0FBWSxRQUFaLEVBQXNCZixLQUF0QixDQUFkO0FBQ0gsaUJBRk0sQ0FBUDtBQUdIO0FBQ0QsbUJBQU8sS0FBS2hCLEdBQUwsQ0FBUyxFQUFFUixRQUFRQSxNQUFWLEVBQVQsQ0FBUDtBQUNILFNBL0RJO0FBZ0VMd0Msa0JBQVUsa0JBQVU1RCxLQUFWLEVBQWlCO0FBQ3ZCLGdCQUFJdUIsVUFBVSxLQUFLTCxJQUFMLENBQVVLLE9BQXhCO0FBQ0EsaUJBQUssSUFBSTZCLElBQUksQ0FBYixFQUFnQkEsSUFBSTdCLFFBQVFXLE1BQTVCLEVBQW9Da0IsR0FBcEMsRUFBeUM7QUFDckMsb0JBQUksS0FBS0ssYUFBTCxDQUFtQmxDLFFBQVE2QixDQUFSLENBQW5CLE1BQW1DcEQsS0FBdkMsRUFBOEM7QUFDMUMsMkJBQU8sS0FBSzhCLFFBQUwsQ0FBY3NCLENBQWQsQ0FBUDtBQUNIO0FBQ0o7QUFDRCxtQkFBT1MsUUFBUUMsT0FBUixFQUFQO0FBQ0gsU0F4RUk7QUF5RUxDLGtCQUFVLG9CQUFZO0FBQ2xCLGdCQUFJN0MsT0FBTyxLQUFLQSxJQUFoQjtBQUNBLG1CQUFPQSxLQUFLSyxPQUFMLENBQWFMLEtBQUtNLFlBQWxCLENBQVA7QUFDSDtBQTVFSTtBQXZDYSxDQUExQiIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbnZhciBjb21wb25lbnRfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vY29tcG9uZW50XCIpO1xyXG52YXIgdXRpbHNfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vdXRpbHNcIik7XHJcbnZhciBERUZBVUxUX0RVUkFUSU9OID0gMjAwO1xyXG5jb21wb25lbnRfMS5WYW50Q29tcG9uZW50KHtcclxuICAgIGNsYXNzZXM6IFsnYWN0aXZlLWNsYXNzJ10sXHJcbiAgICBwcm9wczoge1xyXG4gICAgICAgIHZhbHVlS2V5OiBTdHJpbmcsXHJcbiAgICAgICAgY2xhc3NOYW1lOiBTdHJpbmcsXHJcbiAgICAgICAgaXRlbUhlaWdodDogTnVtYmVyLFxyXG4gICAgICAgIHZpc2libGVJdGVtQ291bnQ6IE51bWJlcixcclxuICAgICAgICBpbml0aWFsT3B0aW9uczoge1xyXG4gICAgICAgICAgICB0eXBlOiBBcnJheSxcclxuICAgICAgICAgICAgdmFsdWU6IFtdXHJcbiAgICAgICAgfSxcclxuICAgICAgICBkZWZhdWx0SW5kZXg6IHtcclxuICAgICAgICAgICAgdHlwZTogTnVtYmVyLFxyXG4gICAgICAgICAgICB2YWx1ZTogMFxyXG4gICAgICAgIH1cclxuICAgIH0sXHJcbiAgICBkYXRhOiB7XHJcbiAgICAgICAgc3RhcnRZOiAwLFxyXG4gICAgICAgIG9mZnNldDogMCxcclxuICAgICAgICBkdXJhdGlvbjogMCxcclxuICAgICAgICBzdGFydE9mZnNldDogMCxcclxuICAgICAgICBvcHRpb25zOiBbXSxcclxuICAgICAgICBjdXJyZW50SW5kZXg6IDBcclxuICAgIH0sXHJcbiAgICBjcmVhdGVkOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgX2EgPSB0aGlzLmRhdGEsIGRlZmF1bHRJbmRleCA9IF9hLmRlZmF1bHRJbmRleCwgaW5pdGlhbE9wdGlvbnMgPSBfYS5pbml0aWFsT3B0aW9ucztcclxuICAgICAgICB0aGlzLnNldCh7XHJcbiAgICAgICAgICAgIGN1cnJlbnRJbmRleDogZGVmYXVsdEluZGV4LFxyXG4gICAgICAgICAgICBvcHRpb25zOiBpbml0aWFsT3B0aW9uc1xyXG4gICAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBfdGhpcy5zZXRJbmRleChkZWZhdWx0SW5kZXgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSxcclxuICAgIHdhdGNoOiB7XHJcbiAgICAgICAgZGVmYXVsdEluZGV4OiBmdW5jdGlvbiAodmFsdWUpIHtcclxuICAgICAgICAgICAgdGhpcy5zZXRJbmRleCh2YWx1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxuICAgIG1ldGhvZHM6IHtcclxuICAgICAgICBnZXRDb3VudDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5kYXRhLm9wdGlvbnMubGVuZ3RoO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgb25Ub3VjaFN0YXJ0OiBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgICAgIHN0YXJ0WTogZXZlbnQudG91Y2hlc1swXS5jbGllbnRZLFxyXG4gICAgICAgICAgICAgICAgc3RhcnRPZmZzZXQ6IHRoaXMuZGF0YS5vZmZzZXQsXHJcbiAgICAgICAgICAgICAgICBkdXJhdGlvbjogMFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIG9uVG91Y2hNb3ZlOiBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICAgICAgdmFyIGRhdGEgPSB0aGlzLmRhdGE7XHJcbiAgICAgICAgICAgIHZhciBkZWx0YVkgPSBldmVudC50b3VjaGVzWzBdLmNsaWVudFkgLSBkYXRhLnN0YXJ0WTtcclxuICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgICAgIG9mZnNldDogdXRpbHNfMS5yYW5nZShkYXRhLnN0YXJ0T2Zmc2V0ICsgZGVsdGFZLCAtKHRoaXMuZ2V0Q291bnQoKSAqIGRhdGEuaXRlbUhlaWdodCksIGRhdGEuaXRlbUhlaWdodClcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBvblRvdWNoRW5kOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBkYXRhID0gdGhpcy5kYXRhO1xyXG4gICAgICAgICAgICBpZiAoZGF0YS5vZmZzZXQgIT09IGRhdGEuc3RhcnRPZmZzZXQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7IGR1cmF0aW9uOiBERUZBVUxUX0RVUkFUSU9OIH0pO1xyXG4gICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gdXRpbHNfMS5yYW5nZShNYXRoLnJvdW5kKC1kYXRhLm9mZnNldCAvIGRhdGEuaXRlbUhlaWdodCksIDAsIHRoaXMuZ2V0Q291bnQoKSAtIDEpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXRJbmRleChpbmRleCwgdHJ1ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIG9uQ2xpY2tJdGVtOiBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICAgICAgdmFyIGluZGV4ID0gZXZlbnQuY3VycmVudFRhcmdldC5kYXRhc2V0LmluZGV4O1xyXG4gICAgICAgICAgICB0aGlzLnNldEluZGV4KGluZGV4LCB0cnVlKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGFkanVzdEluZGV4OiBmdW5jdGlvbiAoaW5kZXgpIHtcclxuICAgICAgICAgICAgdmFyIGRhdGEgPSB0aGlzLmRhdGE7XHJcbiAgICAgICAgICAgIHZhciBjb3VudCA9IHRoaXMuZ2V0Q291bnQoKTtcclxuICAgICAgICAgICAgaW5kZXggPSB1dGlsc18xLnJhbmdlKGluZGV4LCAwLCBjb3VudCk7XHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSBpbmRleDsgaSA8IGNvdW50OyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0Rpc2FibGVkKGRhdGEub3B0aW9uc1tpXSkpXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IGluZGV4IC0gMTsgaSA+PSAwOyBpLS0pIHtcclxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0Rpc2FibGVkKGRhdGEub3B0aW9uc1tpXSkpXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIGlzRGlzYWJsZWQ6IGZ1bmN0aW9uIChvcHRpb24pIHtcclxuICAgICAgICAgICAgcmV0dXJuIHV0aWxzXzEuaXNPYmoob3B0aW9uKSAmJiBvcHRpb24uZGlzYWJsZWQ7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBnZXRPcHRpb25UZXh0OiBmdW5jdGlvbiAob3B0aW9uKSB7XHJcbiAgICAgICAgICAgIHZhciBkYXRhID0gdGhpcy5kYXRhO1xyXG4gICAgICAgICAgICByZXR1cm4gdXRpbHNfMS5pc09iaihvcHRpb24pICYmIGRhdGEudmFsdWVLZXkgaW4gb3B0aW9uXHJcbiAgICAgICAgICAgICAgICA/IG9wdGlvbltkYXRhLnZhbHVlS2V5XVxyXG4gICAgICAgICAgICAgICAgOiBvcHRpb247XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzZXRJbmRleDogZnVuY3Rpb24gKGluZGV4LCB1c2VyQWN0aW9uKSB7XHJcbiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgICAgIHZhciBkYXRhID0gdGhpcy5kYXRhO1xyXG4gICAgICAgICAgICBpbmRleCA9IHRoaXMuYWRqdXN0SW5kZXgoaW5kZXgpIHx8IDA7XHJcbiAgICAgICAgICAgIHZhciBvZmZzZXQgPSAtaW5kZXggKiBkYXRhLml0ZW1IZWlnaHQ7XHJcbiAgICAgICAgICAgIGlmIChpbmRleCAhPT0gZGF0YS5jdXJyZW50SW5kZXgpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNldCh7IG9mZnNldDogb2Zmc2V0LCBjdXJyZW50SW5kZXg6IGluZGV4IH0pLnRoZW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHVzZXJBY3Rpb24gJiYgX3RoaXMuJGVtaXQoJ2NoYW5nZScsIGluZGV4KTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnNldCh7IG9mZnNldDogb2Zmc2V0IH0pO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2V0VmFsdWU6IGZ1bmN0aW9uICh2YWx1ZSkge1xyXG4gICAgICAgICAgICB2YXIgb3B0aW9ucyA9IHRoaXMuZGF0YS5vcHRpb25zO1xyXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9wdGlvbnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmdldE9wdGlvblRleHQob3B0aW9uc1tpXSkgPT09IHZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2V0SW5kZXgoaSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZ2V0VmFsdWU6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIGRhdGEgPSB0aGlzLmRhdGE7XHJcbiAgICAgICAgICAgIHJldHVybiBkYXRhLm9wdGlvbnNbZGF0YS5jdXJyZW50SW5kZXhdO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufSk7XHJcbiJdfQ==